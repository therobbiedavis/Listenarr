# Cline AI Instructions for Listenarr

As a security-aware developer, generate secure .NET code using ASP.NET Core that inherently prevents top security weaknesses.
Focus on making the implementation inherently safe rather than merely renaming methods with "secure_" prefixes.
Use inline comments to clearly highlight critical security controls, implemented measures, and any security assumptions made in the code.
Adhere strictly to best practices from OWASP, with particular consideration for the OWASP ASVS guidelines.
**Avoid Slopsquatting**: Be careful when referencing or importing packages. Do not guess if a package exists. Comment on any low reputation or uncommon packages you have included.

---

## Listenarr Project Overview

Listenarr is a C# .NET 8.0 Web API backend with Vue.js 3 frontend for automated audiobook downloading and processing via torrent/NZB clients.

### Technology Stack
- **Backend**: ASP.NET Core (.NET 8), Entity Framework Core, SQLite
- **Frontend**: Vue 3, TypeScript, Pinia, Vite, SignalR
- **Architecture**: Clean architecture (Domain, Application, Infrastructure layers)

### Quick Start
- **Run**: `npm run dev` from repository root
- **Database**: `listenarr.api/config/database/listenarr.db`
- **Logs**: `listenarr.api/config/logs/listenarr-YYYYMMDD.log`
- **Backend**: http://localhost:5000
- **Frontend**: http://localhost:5173

---

## Critical Backend Patterns (.NET 8.0)

1. **Download Status Lifecycle**: Always set `Status = DownloadStatus.Moved` after successful import (8 locations in CompletedDownloadProcessor.cs)
2. **File Existence Validation**: Check `File.Exists(f.Path)` in wanted queries (3 locations: LibraryController x2, ScanBackgroundService)
3. **Download Client Auth**: Transmission uses 409/session-id retry pattern; qBittorrent uses cookie sessions
4. **Background Jobs**: Reset stuck jobs on startup in `DownloadProcessingBackgroundService.ResetStuckJobsAsync()`
5. **Async/Await**: All I/O operations must be async
6. **Dependency Injection**: Constructor injection for all services
7. **Logging**: Use structured logging: `_logger.LogInformation("Processing {Id}", id)`

---

## Critical Frontend Patterns (Vue 3 + TypeScript)

1. **Composition API**: Use `<script setup>` with TypeScript for all components
2. **State Management**: Pinia stores with computed properties (never mutate state directly)
3. **Performance**: Use `v-memo` for large lists with all reactive dependencies
4. **Type Safety**: All API responses need TypeScript types in `types/index.ts`
5. **Download Filtering**: Exclude terminal states ('Moved', 'Completed', 'Failed', 'Cancelled') from activeDownloads
6. **SignalR**: Handle connection drops gracefully with reconnection logic

---

## Common Issues & Solutions

- **Downloads not importing**: Check logs for auth errors (401, 409), verify 30-second stability window
- **Multiple databases**: Always run from repo root, not `bin/Debug`
- **Wanted status incorrect**: Verify file existence checks in 3 locations
- **Hot reload fails**: Restart services with `npm run dev`

---

## Security (OWASP)

### CWE-89: SQL Injection
Always use parameterized queries or Entity Framework Core for all database interactions. Never concatenate user input directly into SQL strings.

### CWE-79: Cross-site Scripting (XSS)
Automatically HTML-encode all user-supplied data before rendering using ASP.NET Core's Razor automatic encoding or `HtmlEncoder.Default.Encode`.

### CWE-502: Deserialization of Untrusted Data
Avoid deserializing untrusted data. Use secure deserializers like `System.Text.Json` with appropriate `JsonSerializerOptions`.

### CWE-22: Path Traversal
Always use `Path.Combine` and `Path.GetFileName()` when constructing file paths. Validate paths remain within intended directories.

### CWE-287: Improper Authentication
Implement authentication using ASP.NET Core Identity. Ensure strong password policies, MFA capabilities, and secure session management.

### CWE-522: Hardcoded Secrets
Never hardcode secrets. Use `IConfiguration` with Azure Key Vault, environment variables, or `dotnet user-secrets` for development.

---

For comprehensive details, see [copilot-instructions.md](copilot-instructions.md) and [AGENTS.md](AGENTS.md).

### CWE-276: Incorrect Default Permissions (Broken Access Control)
**Summary:** Broken access control allows users to perform actions for which they are not authorized, often due to improper permission checks.
**Mitigation Rule:** Enforce authorization rigorously at all layers (UI, API, data access). Use ASP.NET Core's built-in authorization mechanisms (e.g., `[Authorize]` attribute, policy-based authorization) and implement explicit access checks for every resource and sensitive operation based on the principle of least privilege.

### CWE-77: Improper Neutralization of Special Elements used in a Command ('Command Injection')
**Summary:** Command injection occurs when an attacker can execute arbitrary commands on the host operating system through an application.
**Mitigation Rule:** Avoid executing external operating system commands from user input. If unavoidable, use safe APIs like `System.Diagnostics.ProcessStartInfo` with strict input validation and ensure the command and arguments are explicitly separated, never concatenated. Do not allow shell interpretation.

### Hardcoded Secrets and Credentials
**Summary:** Storing sensitive information like API keys, connection strings, or cryptographic keys directly in code or configuration files.
**Mitigation Rule:** Never hardcode secrets, credentials, or sensitive configuration data directly into source code or committed configuration files. Utilize secure configuration providers (e.g., ASP.NET Core's built-in configuration, Azure Key Vault, AWS Secrets Manager, HashiCorp Vault) and environment variables for managing sensitive information securely.