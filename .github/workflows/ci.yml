name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"
      DOTNET_NOLOGO: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Restore .NET packages
        run: dotnet restore listenarr.sln

      - name: Enforce layering rules
        run: |
          # Fail CI if listenarr.api source files reference listenarr.infrastructure namespaces.
          # This is a lightweight safeguard; for stricter checks consider adding a Roslyn analyzer.
          echo "Checking for layering violations (api -> infrastructure)..."
          set -e
          # Search only C# source files under listenarr.api for references to the infrastructure namespace.
          if git grep -n --no-color "listenarr.infrastructure" -- "listenarr.api/**/*.cs" || git grep -n --no-color "Listenarr.Infrastructure" -- "listenarr.api/**/*.cs"; then
            echo "Layering violation: listenarr.api references listenarr.infrastructure namespaces or symbols." >&2
            echo "Move contracts to listenarr.application / listenarr.domain and implementations to listenarr.infrastructure." >&2
            exit 1
          fi
          echo "No api->infrastructure references found."

      - name: Install frontend deps
        working-directory: fe
        run: npm ci

      - name: Build frontend
        working-directory: fe
        run: npm run build --if-present

      - name: Frontend lint
        working-directory: fe
        run: |
          echo "Running frontend linter (if configured)..."
          # If a lint script exists it will run; --if-present prevents error when absent.
          if npm run lint --silent --if-present; then
            echo "Frontend lint passed (or no lint script present)."
          else
            echo "Frontend lint failed." >&2
            exit 1
          fi

      - name: Run DI assertions
        run: dotnet test tests/Listenarr.Api.Tests/Listenarr.Api.Tests.csproj --no-build --filter FullyQualifiedName~DependencyInjectionTests --verbosity minimal

      - name: Build solution
        run: dotnet build listenarr.sln --no-restore --configuration Release

      - name: Run backend tests
        run: dotnet test listenarr.sln --no-build --verbosity normal

      - name: Run frontend tests
        working-directory: fe
        run: |
          echo "Running frontend tests (if configured)..."
          # Runs tests if test script exists. --if-present makes npm exit 0 when script is absent.
          if npm run test --silent --if-present; then
            echo "Frontend tests ran successfully."
          else
            echo "Frontend tests failed." >&2
            exit 1
          fi
