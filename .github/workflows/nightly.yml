name: Nightly â€” build executables & Docker (develop)

permissions:
  contents: write

on:
  push:
    branches: [ develop ]

jobs:
  nightly-build:
    if: github.actor != 'github-actions'
    runs-on: ubuntu-latest
    env:
      API_PROJECT: listenarr.api/Listenarr.Api.csproj
      FRONTEND_DIR: fe
      API_OUTPUT: listenarr.api/publish

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Restore .NET
        run: dotnet restore ${{ env.API_PROJECT }}

      - name: Build solution
        run: dotnet build listenarr.sln -c Release --no-restore

      - name: Publish API (linux-x64)
        run: dotnet publish ${{ env.API_PROJECT }} -c Release -r linux-x64 --self-contained true /p:PublishSingleFile=true -o ${{ env.API_OUTPUT }}/linux-x64

      - name: Publish API (win-x64)
        run: dotnet publish ${{ env.API_PROJECT }} -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true -o ${{ env.API_OUTPUT }}/win-x64

      - name: Zip Linux artifact
        run: |
          mkdir -p artifacts
          zip -r artifacts/listenarr-api-linux-x64.zip listenarr.api/publish/linux-x64/

      - name: Zip Windows artifact
        run: |
          mkdir -p artifacts
          zip -r artifacts/listenarr-api-win-x64.zip listenarr.api/publish/win-x64/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-artifacts
          path: artifacts/*.zip

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image name
        id: set-tags
        run: |
          # Use repository owner as namespace (avoids embedding secrets into names)
          echo "API_IMAGE=docker.io/${{ github.repository_owner }}/listenarr-api" >> $GITHUB_OUTPUT

      - name: Resolve and bump version (patch)
        id: resolve-version
        run: |
          set -euo pipefail
          CSProj=${{ env.API_PROJECT }}
          # Read <Version> from csproj
          VERSION=$(sed -n "s:.*<Version>\(.*\)</Version>.*:\1:p" "$CSProj" 2>/dev/null || true)
          if [ -z "${VERSION}" ]; then
            VERSION=$(node -p "require('./fe/package.json').version" 2>/dev/null || echo "0.0.0")
          fi
          echo "Found base version: ${VERSION}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "${VERSION}"
          PATCH=${PATCH:-0}
          NEWPATCH=$((PATCH + 1))
          NEWVERSION="${MAJOR}.${MINOR}.${NEWPATCH}"
          echo "Bumped nightly version: ${NEWVERSION}"
          echo "VERSION=${NEWVERSION}" >> $GITHUB_OUTPUT

      - name: Show resolved version
        run: |
          echo "Resolved version: ${{ steps.resolve-version.outputs.VERSION }}"

      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.resolve-version.outputs.VERSION }}
          name: Nightly ${{ steps.resolve-version.outputs.VERSION }}
          body: |
            Automated nightly build.

            Version: ${{ steps.resolve-version.outputs.VERSION }}
            Commit: ${{ github.sha }}
          prerelease: true
          files: artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Persist bumped version to csproj
        if: steps.resolve-version.outputs.VERSION != ''
        env:
          NEW_VERSION: ${{ steps.resolve-version.outputs.VERSION }}
        run: |
          set -euo pipefail
          echo "Updating csproj to version $NEW_VERSION"
          cat > update_version.py <<'PY'
          import os
          import xml.etree.ElementTree as ET
          path = 'listenarr.api/Listenarr.Api.csproj'
          new = os.environ['NEW_VERSION']
          tree = ET.parse(path)
          root = tree.getroot()
          found = False
          for elem in root.findall('.//Version'):
              elem.text = new
              found = True
              break
          if not found:
              pg = root.find('PropertyGroup')
              if pg is None:
                  pg = ET.SubElement(root, 'PropertyGroup')
              ET.SubElement(pg, 'Version').text = new
          tree.write(path, encoding='utf-8', xml_declaration=True)
          print('Wrote new version to csproj')
          PY
          python3 update_version.py

      - name: Create Pull Request for version bump
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Bump version to ${{ steps.resolve-version.outputs.VERSION }}"
          branch: "ci/version-bump-${{ steps.resolve-version.outputs.VERSION }}"
          base: develop
          title: "Bump version to ${{ steps.resolve-version.outputs.VERSION }}"
          body: |
            This PR bumps the application version to ${{ steps.resolve-version.outputs.VERSION }}.
            The change was produced automatically by the CI nightly workflow.
          labels: automated,version-bump

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and push API image (nightly + sha)
        uses: docker/build-push-action@v4
        with:
          context: .
          file: listenarr.api/Dockerfile.runtime
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ steps.set-tags.outputs.API_IMAGE }}:nightly
            ${{ steps.set-tags.outputs.API_IMAGE }}:nightly-${{ steps.resolve-version.outputs.VERSION }}
            ${{ steps.set-tags.outputs.API_IMAGE }}:${{ github.sha }}

      # Skipped: separate Web image. The API image contains the frontend in wwwroot.
